# H17
В результате выполнения работы было реализованно два supervision.
Первый отвеает за запуск keylist_mgr и keylist_sup

# main_sup
```
%%%-------------------------------------------------------------------
%%% @author kolpa
%%% @copyright (C) 2023, <COMPANY>
%%% @doc
%%%
%%% @end
%%% Created : 24. дек. 2023 20:17
%%%-------------------------------------------------------------------
-module(main_sup).
-author("kolpa").

-behaviour(supervisor).

%% API
-export([start_link/0]).

%% Callbacks
-export([init/1, terminate/2]).

start_link() ->
  supervisor:start_link({local, ?MODULE}, ?MODULE, []).

init([]) ->
  io:format("Init main supervisor ~p~n", [?MODULE]),

  SupFlags = #{
    strategy => one_for_one, %% Была выбранна данная стратегия, потому что В данном случае создаются 2 наблюдаемых процесса. Первый не обладает какими либо под процессами, а у второво их n-множество.
    %% Поэтому если keylist_mgr завершится keylist_sup не должен перезапускаться с его n-процессами. 
    intensity => 1,
    period => 5
  },
  ChildSpecs = [
    #{
      id => keylist_mgr,
      start => {keylist_mgr, start, []},
      restart => permanent
    },

    #{
      id => keylist_sup,
      start => {keylist_sup, start_link, []},
      restart => permanent
    }
  ],

  {ok, {SupFlags, ChildSpecs}}.

terminate(_Reason, _State) ->
  ok = supervisor:terminate_child(main_sup, keylist_mgr),
  ok.
```

# keylist_sup
```
-module(keylist_sup).
-author("kolpa").

-behaviour(supervisor).

%% API
-export([start_link/0, start_child/1, stop_child/1]).

%% Callback
-export([init/1]).

start_link() ->
  supervisor:start_link({local, ?MODULE}, ?MODULE, []).

start_child(Names) ->
  lists:foreach(
    fun(Name) ->
      supervisor:start_child(?MODULE, [Name])
    end,
    Names
  ).

stop_child(Name) ->
  supervisor:terminate_child(?MODULE, whereis(Name)).

init(_Args) ->
  io:format("Init keylist supervisor ~n"),
  SupFlags = #{
    strategy => one_for_one, %% Если упадёт один процесс, то зачем перезапускать и все остальные, поэтому была выбранна данная стратегия перезапуска.
    intensity => 1,
    period => 5
  },

  KeylistNames = [keylist1, keylist2, keylist3],

  ChildSpecs = lists:map(
    fun(Name) ->
      #{
        id => Name,
        start => {keylist, start_link, [Name]},
        restart => permanent
      }
    end,
    KeylistNames
  ),

  {ok, {SupFlags, ChildSpecs}}.
```

# Result
```
1> main_sup:start_link().
Init main supervisor main_sup
Initializing keylist_mgr process
Failed to delete records from ETS table: badarg
Init keylist_mgr process
Initializing keylist supervisor
{ok,<0.87.0>}
2> keylist_sup:start_child(keylist1).
Starting keylist process with Name: keylist1
Initializing keylist process with Name: keylist1
{ok,<0.91.0>}
3> keylist_sup:start_child(keylist2).
Starting keylist process with Name: keylist2
Initializing keylist process with Name: keylist2
{ok,<0.93.0>}
4> keylist_sup:start_child(keylist3).
Starting keylist process with Name: keylist3
Initializing keylist process with Name: keylist3
{ok,<0.95.0>}
5> keylist:add(keylist1, "key1", "value1", "comment1").
ok
6> keylist:add(keylist1, "key2", "value2", "comment2").
ok
7> keylist:find(keylist1, "key1").
[{keylist_record,"key1","value1","comment1"}]
8> keylist:find(keylist1, "key2").
[{keylist_record,"key2","value2","comment2"}]
9> exit(whereis(keylist1), kill).
Starting keylist process with Name: keylist1
=SUPERVISOR REPORT==== 15-Jan-2024::19:02:50.099000 ===
    supervisor: {local,keylist_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.91.0>},
               {id,keylist},
               {mfargs,{keylist,start_link,[keylist1]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

true
Initializing keylist process with Name: keylist1
10> whereis(keylist1).
<0.101.0>
11> exit(whereis(keylist_sup), kill).
Initializing keylist supervisor
=SUPERVISOR REPORT==== 15-Jan-2024::19:03:01.342000 ===
    supervisor: {local,main_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.89.0>},
               {id,keylist_sup},
               {mfargs,{keylist_sup,start_link,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

true
12> whereis(keylist1).
undefined
13>  whereis(keylist_sup).
<0.104.0>
14> whereis(keylist_mgr).
<0.88.0>
15> exit(whereis(keylist_mgr), kill).
=SUPERVISOR REPORT==== 15-Jan-2024::19:03:18.605000 ===
    supervisor: {local,main_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.88.0>},
               {id,keylist_mgr},
               {mfargs,{keylist_mgr,start,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

Initializing keylist_mgr process
true
Init keylist_mgr process
Initializing keylist supervisor
16> whereis(keylist_mgr).
<0.109.0>
```
Я изучил ваше видео с комментариями по поводу keylist_mgr.
К сожалению у меня мало времени, у меня стоит сдача курсовой работы 15 января.