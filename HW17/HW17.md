# H17
В результате выполнения работы было реализованно два supervision.
Первый отвеает за запуск keylist_mgr и keylist_sup

# main_sup
```
%%%-------------------------------------------------------------------
%%% @author kolpa
%%% @copyright (C) 2023, <COMPANY>
%%% @doc
%%%
%%% @end
%%% Created : 24. дек. 2023 20:17
%%%-------------------------------------------------------------------
-module(main_sup).
-author("kolpa").

-behaviour(supervisor).

%% API
-export([start_link/0]).

%% Callbacks
-export([init/1, terminate/2]).

start_link() ->
  supervisor:start_link({local, ?MODULE}, ?MODULE, []).

init([]) ->
  io:format("Init main supervisor ~p~n", [?MODULE]),

  SupFlags = #{
    strategy => one_for_one, %% Была выбранна данная стратегия, потому что В данном случае создаются 2 наблюдаемых процесса. Первый не обладает какими либо под процессами, а у второво их n-множество.
    %% Поэтому если keylist_mgr завершится keylist_sup не должен перезапускаться с его n-процессами. 
    intensity => 1,
    period => 5
  },
  ChildSpecs = [
    #{
      id => keylist_mgr,
      start => {keylist_mgr, start, []},
      restart => permanent
    },

    #{
      id => keylist_sup,
      start => {keylist_sup, start_link, []},
      restart => permanent
    }
  ],

  {ok, {SupFlags, ChildSpecs}}.

terminate(_Reason, _State) ->
  ok = supervisor:terminate_child(main_sup, keylist_mgr),
  ok.
```

# keylist_sup
```
-module(keylist_sup).
-author("kolpa").

-behaviour(supervisor).

%% API
-export([start_link/0, start_child/1, stop_child/1]).

%% Callback
-export([init/1]).

start_link() ->
  supervisor:start_link({local, ?MODULE}, ?MODULE, []).

start_child(Names) ->
  lists:foreach(
    fun(Name) ->
      supervisor:start_child(?MODULE, [Name])
    end,
    Names
  ).

stop_child(Name) ->
  supervisor:terminate_child(?MODULE, whereis(Name)).

init(_Args) ->
  io:format("Init keylist supervisor ~n"),
  SupFlags = #{
    strategy => one_for_one, %% Если упадёт один процесс, то зачем перезапускать и все остальные, поэтому была выбранна данная стратегия перезапуска.
    intensity => 1,
    period => 5
  },

  KeylistNames = [keylist1, keylist2, keylist3],

  ChildSpecs = lists:map(
    fun(Name) ->
      #{
        id => Name,
        start => {keylist, start_link, [Name]},
        restart => permanent
      }
    end,
    KeylistNames
  ),

  {ok, {SupFlags, ChildSpecs}}.
```

# Result
```
1> main_sup:start_link().
Init main supervisor main_sup
Initializing keylist_mgr process
Init keylist_mgr process
Init keylist supervisor
Starting keylist process with Name: keylist1
Initializing keylist process with Name: keylist1
Starting keylist process with Name: keylist2
Initializing keylist process with Name: keylist2
Starting keylist process with Name: keylist3
Initializing keylist process with Name: keylist3
{ok,<0.87.0>}
2> keylist:add(keylist1, "key1", "value1", "comment1").
ok
3> keylist:add(keylist1, "key2", "value2", "comment2").
ok
4> keylist:find(keylist1, "key1").
[{keylist_record,"key1","value1","comment1"}]
5> keylist:find(keylist1, "key2").
[{keylist_record,"key2","value2","comment2"}]
6> observer:start().
ok 
```
![img_1.png](img_1.png)
```
7> exit(whereis(keylist1), kill).
Starting keylist process with Name: keylist1
=SUPERVISOR REPORT==== 1-Jan-2024::14:03:30.565000 ===
    supervisor: {local,keylist_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.90.0>},
               {id,keylist1},
               {mfargs,{keylist,start_link,[keylist1]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

true
Initializing keylist process with Name: keylist1
8> whereis(keylist1).
<0.1266.0>
9> exit(whereis(keylist_sup), kill).
Init keylist supervisor
=SUPERVISOR REPORT==== 1-Jan-2024::14:03:51.621000 ===
    supervisor: {local,main_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.89.0>},
               {id,keylist_sup},
               {mfargs,{keylist_sup,start_link,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

true
Starting keylist process with Name: keylist1
Initializing keylist process with Name: keylist1
Starting keylist process with Name: keylist2
Initializing keylist process with Name: keylist2
Starting keylist process with Name: keylist3
Initializing keylist process with Name: keylist3
10> whereis(keylist1).
<0.1371.0>
11> whereis(keylist_sup).
<0.1369.0>
12> whereis(keylist_mgr).
<0.88.0>
13> exit(whereis(keylist_mgr), kill).
Initializing keylist_mgr process
=SUPERVISOR REPORT==== 1-Jan-2024::14:04:19.700000 ===
    supervisor: {local,main_sup}
    errorContext: child_terminated
    reason: killed
    offender: [{pid,<0.88.0>},
               {id,keylist_mgr},
               {mfargs,{keylist_mgr,start,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

true
=SUPERVISOR REPORT==== 1-Jan-2024::14:04:19.701000 ===
    supervisor: {local,main_sup}
    errorContext: start_error
    reason: {'EXIT',
                {badarg,
                    [{ets,new,
                         [keylist_ets,[set,public,named_table,{keypos,2}]],
                         [{error_info,
                              #{cause => already_exists,
                                module => erl_stdlib_errors}}]},
                     {keylist_mgr,start,0,
                         [{file,"keylist_mgr.erl"},{line,23}]},
                     {supervisor,do_start_child_i,3,
                         [{file,"supervisor.erl"},{line,420}]},
                     {supervisor,do_start_child,2,
                         [{file,"supervisor.erl"},{line,406}]},
                     {supervisor,restart,3,
                         [{file,"supervisor.erl"},{line,845}]},
                     {supervisor,restart,2,
                         [{file,"supervisor.erl"},{line,800}]},
                     {supervisor,handle_info,2,
                         [{file,"supervisor.erl"},{line,615}]},
                     {gen_server,try_handle_info,3,
                         [{file,"gen_server.erl"},{line,1077}]}]}}
    offender: [{pid,<0.88.0>},
               {id,keylist_mgr},
               {mfargs,{keylist_mgr,start,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

=SUPERVISOR REPORT==== 1-Jan-2024::14:04:19.701000 ===
    supervisor: {local,main_sup}
    errorContext: shutdown
    reason: reached_max_restart_intensity
    offender: [{pid,{restarting,<0.88.0>}},
               {id,keylist_mgr},
               {mfargs,{keylist_mgr,start,[]}},
               {restart_type,permanent},
               {significant,false},
               {shutdown,5000},
               {child_type,worker}]

** exception exit: shutdown
14>
```
Я изучил ваше видео с комментариями по поводу keylist_mgr.
К сожалению у меня мало времени, у меня стоит сдача курсовой работы 15 января.